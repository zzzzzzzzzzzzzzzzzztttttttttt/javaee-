<!DOCTYPE html>
<html lang="zh-CN" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>å•†å“è¯¦æƒ…</title>
    <style>
        .detail-container { display: flex; padding: 20px; gap: 30px; }
        .goods-img { width: 400px; height: 400px; }
        .info-container { flex: 1; }
        .price { color: red; font-size: 24px; }
        .num-control { margin: 20px 0; }
        .btn-add { padding: 10px 20px; background: #ff4400; color: white; border: none; cursor: pointer; }
    </style>
</head>
<body>
<div class="detail-container">
    <!-- å•†å“å›¾ç‰‡ -->
    <img th:src="${goods.goodsImg}" alt="å•†å“å›¾ç‰‡" class="goods-img">

    <!-- å•†å“ä¿¡æ¯ -->
    <div class="info-container">
        <h1 th:text="${goods.goodsName}"></h1>
        <p class="price">Â¥<span th:text="${goods.price}"></span></p>
        <p>åº“å­˜ï¼š<span th:text="${goods.stock}"></span>ä»¶</p>
        <p th:text="${goods.goodsDesc}"></p>

        <div class="num-control">
            <button onclick="changeNum(-1)">-</button>
            <input type="number" id="num" value="1" min="1" th:max="${goods.stock}">
            <button onclick="changeNum(1)">+</button>
        </div>

        <button class="btn-add" onclick="addCart(${goods.goodsId})">åŠ å…¥è´­ç‰©è½¦</button>
    </div>
</div>

<script>
    function changeNum(step) {
        const input = document.getElementById('num');
        let num = parseInt(input.value) + step;
        input.value = Math.max(1, Math.min(num, parseInt(input.max)));
    }
    function addCart(goodsId) {
        console.log('addCart', goodsId);

        // 1. è·å–å‚æ•°å¹¶æ ¡éªŒ
        const numInput = document.getElementById('num');
        const num = numInput ? numInput.value : 1; // å…¼å®¹numå…ƒç´ ä¸å­˜åœ¨çš„æƒ…å†µ
        // ä»sessionStorage/ç™»å½•ä¿¡æ¯ä¸­è·å–userIdï¼ˆæ›¿æ¢å†™æ­»çš„1ï¼‰
        const userId = sessionStorage.getItem('userId') || document.getElementById('userId')?.value || 1;

        // æ ¡éªŒæ•°é‡
        if (!/^[1-9]\d*$/.test(num)) {
            alert('è¯·è¾“å…¥æœ‰æ•ˆçš„è´­ä¹°æ•°é‡ï¼ˆæ­£æ•´æ•°ï¼‰');
            numInput.focus();
            return;
        }

        // 2. æ„é€ è¯·æ±‚å‚æ•°ï¼ˆPOSTè¯·æ±‚æ¨èç”¨bodyä¼ å‚ï¼‰
        const params = {
            userId: userId,
            goodsId: goodsId,
            num: parseInt(num)
        };

        // 3. å‘é€è¯·æ±‚ï¼ˆä¼˜åŒ–ç‰ˆï¼‰
        fetch('/cart/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json', // å£°æ˜JSONæ ¼å¼
                'X-Requested-With': 'XMLHttpRequest' // æ ‡è¯†AJAXè¯·æ±‚
            },
            body: JSON.stringify(params) // POSTå‚æ•°æ”¾åœ¨bodyä¸­
        })
            // 4. ç»Ÿä¸€å¤„ç†å“åº”ï¼ˆå…¼å®¹æ–‡æœ¬/JSONï¼‰
            .then(async (res) => {
                if (!res.ok) {
                    throw new Error(`HTTPé”™è¯¯ï¼ŒçŠ¶æ€ç ï¼š${res.status}`);
                }
                // å…ˆå°è¯•æŒ‰æ–‡æœ¬è§£æï¼Œå†å…¼å®¹JSON
                const text = await res.text();
                try {
                    // å¦‚æœæ˜¯JSONæ ¼å¼ï¼Œè§£ææˆå¯¹è±¡
                    return JSON.parse(text);
                } catch (e) {
                    // çº¯æ–‡æœ¬ç›´æ¥è¿”å›
                    return text;
                }
            })
            // 5. å¤„ç†ä¸šåŠ¡é€»è¾‘
            .then((data) => {
                // å…¼å®¹åç«¯è¿”å›çº¯å­—ç¬¦ä¸²ï¼ˆsuccess/failï¼‰æˆ–JSONå¯¹è±¡
                const isSuccess = data === 'success' || (typeof data === 'object' && data.success);
                const msg = isSuccess
                    ? 'åŠ å…¥è´­ç‰©è½¦æˆåŠŸğŸ‰'
                    : (data.msg || data || 'åŠ å…¥è´­ç‰©è½¦å¤±è´¥ğŸ˜¥');
                alert(msg);

                // å¯é€‰ï¼šæ·»åŠ æˆåŠŸååˆ·æ–°è´­ç‰©è½¦æ•°é‡
                // updateCartCount();
            })
            // 6. æ•è·æ‰€æœ‰å¼‚å¸¸ï¼ˆç½‘ç»œ/è§£æ/ä¸šåŠ¡ï¼‰
            .catch((err) => {
                console.error('æ·»åŠ è´­ç‰©è½¦å¼‚å¸¸ï¼š', err);
                alert(`æ·»åŠ è´­ç‰©è½¦å¤±è´¥ï¼š${err.message}`);
            });
    }
</script>
</body>
</html>